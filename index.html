<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Charge Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
        }
        /* Custom scrollbar for better mobile feel */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Slate 300 */
            border-radius: 4px;
        }
        /* Ensure table cells truncate well on smaller screens */
        .truncate-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .text-nowrap {
            white-space: nowrap;
        }
        .disabled-select {
            background-color: #f3f4f6; /* bg-gray-100 */
            cursor: not-allowed;
            opacity: 0.75;
        }
    </style>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header / Navigation Bar -->
        <header class="bg-indigo-600 text-white shadow-lg sticky top-0 z-10">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="text-xl font-bold tracking-tight">Job Manager</div>
                    <nav class="flex space-x-2">
                        <button onclick="navigate('clients')" class="nav-btn hover:bg-indigo-500">Clients</button>
                        <button onclick="navigate('projects')" class="nav-btn hover:bg-indigo-500">Projects</button>
                        <button onclick="navigate('billing')" class="nav-btn hover:bg-indigo-500">Billing</button>
                        <button onclick="navigate('reports')" class="nav-btn hover:bg-indigo-500">Reports</button>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow max-w-4xl w-full mx-auto p-4 sm:p-6 lg:p-8">
            <div id="loading-indicator" class="text-center py-12 text-indigo-500 hidden">
                <svg class="animate-spin h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-sm font-medium">Initializing App and Fetching Data...</p>
            </div>

            <!-- Views Container -->
            <div id="views-container">
                <!-- CLIENTS VIEW -->
                <section id="clients-view" class="view hidden" data-view="clients">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">Client Management</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-semibold text-indigo-600 mb-4">Add New Client</h3>
                        <form id="add-client-form" onsubmit="addClient(event)">
                            <div class="space-y-4">
                                <input type="text" id="client-name" placeholder="Client Name (e.g., 'John Doe')" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                                <input type="text" id="client-company" placeholder="Client Company Name"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                                <input type="text" id="client-address" placeholder="Client Address (Street, City, Zip)"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                                <input type="text" id="client-contact" placeholder="Contact Email/Phone"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                                <button type="submit"
                                    class="w-full bg-indigo-500 text-white p-3 rounded-lg font-semibold shadow-md hover:bg-indigo-600 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99]">
                                    Add Client
                                </button>
                            </div>
                            <p id="client-error" class="text-red-500 text-sm mt-2 hidden"></p>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                            Your Clients
                            <span id="client-count" class="text-sm font-medium text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full">0 Clients</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Name</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Company</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Address</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Contact</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="clients-list" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        <p id="no-clients-message" class="text-gray-500 text-center py-4 hidden">No clients added yet. Start by adding one above!</p>
                    </div>
                </section>

                <!-- PROJECTS VIEW -->
                <section id="projects-view" class="view hidden" data-view="projects">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">Project Management</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-semibold text-green-600 mb-4">Add New Project</h3>
                        <form id="add-project-form" onsubmit="addProject(event)">
                            <div class="space-y-4">
                                <input type="text" id="project-name" placeholder="Project Name (e.g., 'Main Street Renovation')" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm transition duration-150">
                                <select id="project-client-id" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm transition duration-150">
                                    <option value="" disabled selected>Select Associated Client *</option>
                                </select>
                                <select id="project-type-of-work" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm transition duration-150">
                                    <option value="" disabled selected>Select Type of Work *</option>
                                    <option value="Strata">Strata</option>
                                    <option value="Office">Office</option>
                                    <option value="Domestic">Domestic</option>
                                    <option value="Miscellaneous">Miscellaneous</option>
                                </select>
                                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <label for="project-is-active" class="text-gray-700 font-medium">Project Active?</label>
                                    <select id="project-is-active" class="p-2 border border-gray-300 rounded-lg">
                                        <option value="yes" selected>Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>
                                <button type="submit"
                                    class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold shadow-md hover:bg-green-600 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99]">
                                    Add Project
                                </button>
                            </div>
                            <p id="project-error" class="text-red-500 text-sm mt-2 hidden"></p>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                            Your Projects
                            <span id="project-count" class="text-sm font-medium text-green-500 bg-green-50 px-3 py-1 rounded-full">0 Projects</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Project Name</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Client</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Type</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Active</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="projects-list" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        <p id="no-projects-message" class="text-gray-500 text-center py-4 hidden">No projects added yet. Start by adding one above!</p>
                    </div>
                </section>

                <!-- BILLING VIEW -->
                <section id="billing-view" class="view hidden" data-view="billing">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">Billing Entries</h2>

                    <!-- Add New Billing Entry Form -->
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-semibold text-teal-600 mb-4">Log New Billable Item</h3>
                        <form id="add-billing-form" onsubmit="addBillingEntry(event)">
                            <div class="space-y-4">
                                <!-- 1. Client Selection (Step 1 of filtering) -->
                                <select id="billing-client-id" required onchange="handleBillingClientChange()"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150">
                                    <option value="" disabled selected>Select Client *</option>
                                </select>

                                <!-- 2. Project Selection (Filtered based on Client) -->
                                <select id="billing-project-id" required onchange="updateBillingDetails()" disabled
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150 disabled-select">
                                    <option value="" disabled selected>Select Project *</option>
                                    <!-- Projects filtered by client will be populated by JS -->
                                </select>

                                <!-- Derived Info Display -->
                                <div id="derived-billing-info" class="p-3 bg-teal-50 text-teal-800 rounded-lg text-sm space-y-1">
                                    <p class="font-medium">Client: <span id="display-client-name">---</span></p>
                                    <p class="font-medium">Work Type: <span id="display-work-type">---</span></p>
                                </div>
                                
                                <!-- NEW: Saved Description Selection -->
                                <select id="saved-description-select" onchange="loadSavedDescription('billing-item-desc')"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150">
                                    <option value="" disabled selected>--- Load Saved Description ---</option>
                                    <!-- Descriptions populated by JS -->
                                </select>

                                <!-- 3. Item Description (Type a new one or load from above) -->
                                <input type="text" id="billing-item-desc" placeholder="Work Description (Type a new one or load from above)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150">
                                
                                <!-- NEW: Save Description Checkbox -->
                                <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <input type="checkbox" id="save-new-description" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                    <label for="save-new-description" class="text-sm font-medium text-gray-700">Save this description for future use?</label>
                                </div>

                                <!-- 4. Billing Date -->
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <div class="w-full">
                                        <label for="billing-date" class="block text-sm font-medium text-gray-700 mb-1">Billing Date *</label>
                                        <input type="date" id="billing-date" required value=""
                                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150">
                                    </div>
                                    <div class="w-full">
                                        <label for="billing-job-done" class="block text-sm font-medium text-gray-700 mb-1">Job Done? *</label>
                                        <select id="billing-job-done" class="w-full p-3 border border-gray-300 rounded-lg">
                                            <option value="yes" selected>Yes</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 5. Rate and Hours -->
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <div class="w-full">
                                        <label for="billing-rate" class="block text-sm font-medium text-gray-700 mb-1">Rate per Hour (USD) *</label>
                                        <input type="number" id="billing-rate" placeholder="e.g., 50" required step="0.01" min="0"
                                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150">
                                    </div>
                                    <div class="w-full">
                                        <label for="billing-hours" class="block text-sm font-medium text-gray-700 mb-1">Hours Worked *</label>
                                        <input type="number" id="billing-hours" placeholder="e.g., 4.5" required step="0.1" min="0"
                                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150">
                                    </div>
                                </div>
                                
                                <button type="submit"
                                    class="w-full bg-teal-500 text-white p-3 rounded-lg font-semibold shadow-md hover:bg-teal-600 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99]">
                                    Log Billable Entry
                                </button>
                            </div>
                            <p id="billing-error" class="text-red-500 text-sm mt-2 hidden"></p>
                        </form>
                    </div>

                    <!-- Billing Entries List (Table) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                            Billable Items
                            <span id="billing-count" class="text-sm font-medium text-teal-500 bg-teal-50 px-3 py-1 rounded-full">0 Entries</span>
                        </h3>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-nowrap">Date / Project</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Description</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-nowrap">Rate/Hrs</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider text-nowrap">Charge</th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Done</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider text-nowrap">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="billing-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Billing entry table rows will be injected here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <p id="no-billing-message" class="text-gray-500 text-center py-4 hidden">No billable items logged yet.</p>
                    </div>
                </section>

                <!-- REPORTS VIEW (STEP 5 FOCUS) -->
                <section id="reports-view" class="view hidden" data-view="reports">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2 text-purple-700">Financial Reports & Totals</h2>

                    <!-- Report Filter Controls -->
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-semibold text-purple-600 mb-4">Report Filters</h3>
                        <form id="report-filters-form" onsubmit="calculateReports(event)">
                            <div class="space-y-4">
                                <!-- Date Range -->
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <div class="w-full">
                                        <label for="report-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
                                        <input type="date" id="report-start-date" required
                                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm transition duration-150">
                                    </div>
                                    <div class="w-full">
                                        <label for="report-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date *</label>
                                        <input type="date" id="report-end-date" required
                                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm transition duration-150">
                                    </div>
                                </div>

                                <!-- Grouping/Filtering -->
                                <div>
                                    <label for="report-group-by" class="block text-sm font-medium text-gray-700 mb-1">Group By/Totals</label>
                                    <select id="report-group-by"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm transition duration-150">
                                        <option value="all">All Entries (Summary Only)</option>
                                        <option value="client">Client Name</option>
                                        <option value="typeOfWork">Type of Work (Strata, Office, etc.)</option>
                                    </select>
                                </div>
                                
                                <button type="submit"
                                    class="w-full bg-purple-500 text-white p-3 rounded-lg font-semibold shadow-md hover:bg-purple-600 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99]">
                                    Generate Report
                                </button>
                            </div>
                            <p id="report-error" class="text-red-500 text-sm mt-2 hidden"></p>
                        </form>
                    </div>

                    <!-- Report Output Area -->
                    <div id="report-output" class="bg-white p-6 rounded-xl shadow-lg">
                        <p class="text-gray-500 text-center py-8">Select a date range and grouping option above to generate a report.</p>
                        <!-- Summary and detailed breakdown will be injected here -->
                    </div>
                </section>
            </div>

            <!-- Status/Auth Info -->
            <footer class="mt-8 text-center text-xs text-gray-500 border-t pt-4">
                <p>App ID: <span id="app-id-display"></span></p>
                <p>User ID: <span id="user-id-display"></span></p>
                <p class="mt-1 text-red-500">Note: Data is saved instantly using Google Firestore.</p>
            </footer>

        </main>
    </div>

    <!-- Universal Modal Structure for Editing -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
        
        <!-- Client Edit Modal -->
        <div id="edit-client-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all overflow-hidden hidden" role="dialog" aria-modal="true">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">Edit Client</h3>
                <form id="edit-client-form" onsubmit="updateClient(event)">
                    <input type="hidden" id="edit-client-id">
                    <div class="space-y-4">
                        <input type="text" id="edit-client-name" placeholder="Client Name" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        <input type="text" id="edit-client-company" placeholder="Company Name"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        <input type="text" id="edit-client-address" placeholder="Address"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        <input type="text" id="edit-client-contact" placeholder="Contact"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('edit-client-modal')"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-indigo-500 rounded-lg shadow-md hover:bg-indigo-600 transition">
                            Save Changes
                        </button>
                    </div>
                    <p id="edit-client-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </form>
            </div>
        </div>

        <!-- Project Edit Modal -->
        <div id="edit-project-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all overflow-hidden hidden" role="dialog" aria-modal="true">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-green-600 mb-4 border-b pb-2">Edit Project</h3>
                <form id="edit-project-form" onsubmit="updateProject(event)">
                    <input type="hidden" id="edit-project-id">
                    <div class="space-y-4">
                        <input type="text" id="edit-project-name" placeholder="Project Name" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">
                        <select id="edit-project-client-id" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">
                            <option value="" disabled selected>Select Associated Client *</option>
                        </select>
                        <select id="edit-project-type-of-work" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm">
                            <option value="Strata">Strata</option>
                            <option value="Office">Office</option>
                            <option value="Domestic">Domestic</option>
                            <option value="Miscellaneous">Miscellaneous</option>
                        </select>
                        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <label for="edit-project-is-active" class="text-gray-700 font-medium">Project Active?</label>
                            <select id="edit-project-is-active" class="p-2 border border-gray-300 rounded-lg">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('edit-project-modal')"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-lg shadow-md hover:bg-green-600 transition">
                            Save Changes
                        </button>
                    </div>
                    <p id="edit-project-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </form>
            </div>
        </div>

        <!-- Billing Edit Modal -->
        <div id="edit-billing-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all overflow-hidden hidden" role="dialog" aria-modal="true">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-teal-600 mb-4 border-b pb-2">Edit Billable Entry</h3>
                <form id="edit-billing-form" onsubmit="updateBillingEntry(event)">
                    <input type="hidden" id="edit-billing-id">
                    <div class="space-y-4">
                        <!-- Read-only Client/Project Info -->
                        <div class="p-3 bg-gray-50 text-gray-700 rounded-lg text-sm space-y-1">
                            <p class="font-medium">Client: <span id="edit-display-client-name" class="font-bold">---</span></p>
                            <p class="font-medium">Project: <span id="edit-display-project-name" class="font-bold">---</span></p>
                            <p class="font-medium">Work Type: <span id="edit-display-work-type">---</span></p>
                        </div>
                        
                        <!-- Saved Description Selection -->
                        <select id="edit-saved-description-select" onchange="loadSavedDescription('edit-billing-item-desc', 'edit-saved-description-select')"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm transition duration-150">
                            <option value="" disabled selected>--- Load Saved Description ---</option>
                            <!-- Descriptions populated by JS -->
                        </select>

                        <input type="text" id="edit-billing-item-desc" placeholder="Work Description" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm">
                        
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="w-full">
                                <label for="edit-billing-date" class="block text-sm font-medium text-gray-700 mb-1">Billing Date *</label>
                                <input type="date" id="edit-billing-date" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm">
                            </div>
                            <div class="w-full">
                                <label for="edit-billing-job-done" class="block text-sm font-medium text-gray-700 mb-1">Job Done? *</label>
                                <select id="edit-billing-job-done" class="w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="w-full">
                                <label for="edit-billing-rate" class="block text-sm font-medium text-gray-700 mb-1">Rate per Hour (USD) *</label>
                                <input type="number" id="edit-billing-rate" required step="0.01" min="0"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm">
                            </div>
                            <div class="w-full">
                                <label for="edit-billing-hours" class="block text-sm font-medium text-gray-700 mb-1">Hours Worked *</label>
                                <input type="number" id="edit-billing-hours" required step="0.1" min="0"
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 shadow-sm">
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('edit-billing-modal')"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                            Cancel
                        </button>
                        <button type="submit"
                            class="px-4 py-2 text-sm font-medium text-white bg-teal-500 rounded-lg shadow-md hover:bg-teal-600 transition">
                            Save Changes
                        </button>
                    </div>
                    <p id="edit-billing-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </form>
            </div>
        </div>
    </div>
<script src="./config.js"></script>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, serverTimestamp, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // FALLBACK CONFIGURATION FOR LOCAL TESTING:
        // When running outside the Canvas environment (e.g., locally in Chrome), 
        // the required global variables are undefined. We use this fallback 
        // configuration and ID to ensure the app initializes and stores data locally.
        const defaultAppId = 'local-job-manager';
        const fallbackFirebaseConfig = {
               apiKey: "AIzaSyDEiUakvzE6acvLMwSVYoqqP7WKKHhyR4U",
               authDomain: "clientbillinglive.firebaseapp.com",
               projectId: "clientbillinglive",
                storageBucket: "clientbillinglive.firebasestorage.app",
               messagingSenderId: "400586974621",
               appId: "1:400586974621:web:1acecdaa4158ab0de4bb74"
         };
        
        // Determine final configuration settings: prefer Canvas variables, use fallback otherwise.
        const appId = typeof __app_id !== 'undefined' ? __app_id : defaultAppId;
        
        // NEW: Check if we are running in the local fallback mode (no real config provided)
        const isLocalFallback = (typeof __firebase_config === 'undefined' || __firebase_config.length < 20);

        let config = {};
        if (isLocalFallback) {
             config = fallbackFirebaseConfig;
        } else {
            try {
                config = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Error parsing __firebase_config, using fallback:", e);
                config = fallbackFirebaseConfig;
            }
        }
        
        const firebaseConfig = config;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let currentUserId = null;
        let clients = []; 
        let projects = []; 
        let billingEntries = []; 
        let workDescriptions = []; 

        // Expose functions to the global scope for use in the HTML
        window.navigate = navigate;
        window.addClient = addClient;
        window.deleteClient = deleteClient;
        window.editClient = showEditClientModal; 
        window.updateClient = updateClient; 
        window.addProject = addProject;
        window.deleteProject = deleteProject;
        window.editProject = showEditProjectModal; 
        window.updateProject = updateProject; 
        window.addBillingEntry = addBillingEntry; 
        window.deleteBillingEntry = deleteBillingEntry; 
        window.editBillingEntry = showEditBillingModal; 
        window.updateBillingEntry = updateBillingEntry; 
        window.updateBillingDetails = updateBillingDetails;
        window.handleBillingClientChange = handleBillingClientChange;
        window.calculateReports = calculateReports; 
        window.loadSavedDescription = loadSavedDescription;
        window.closeModal = closeModal;

        // --- Core Application Logic ---

        // 1. Initialize Firebase and Auth
        async function initFirebase() {
            setLogLevel('debug');

            if (isLocalFallback) {
                console.warn("Running in LOCAL FALLBACK MODE. Data persistence is DISABLED.");
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('app-id-display').textContent = 'LOCAL (Non-Persistent)';
                document.getElementById('user-id-display').textContent = 'ANONYMOUS/NO SAVE';
                db = null; // Mark DB as non-functional
                auth = null; // Mark Auth as non-functional
                navigate('clients'); // Show UI immediately
                
                // Show a clear error message in the console and footer
                const footer = document.querySelector('footer p.mt-1');
                if (footer) {
                    footer.innerHTML = '<span class="text-red-500 font-bold">LOCAL FALLBACK: Data NOT SAVED. Use the main platform for persistence.</span>';
                }
                return; // Skip the failing Firebase initialization and authentication
            }

            // The rest runs ONLY if we have a valid configuration (i.e., inside the Canvas)
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                document.getElementById('app-id-display').textContent = appId;

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('user-id-display').textContent = currentUserId;
                        console.log("Authenticated with UID:", currentUserId);
                        setupListeners();
                        navigate('clients'); // Default view
                        document.getElementById('loading-indicator').classList.add('hidden');
                    } else {
                        handleInitialAuth();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-indicator').innerHTML = `<p class="text-red-500">Initialization Error: ${error.message}</p>`;
            }
        }

        async function handleInitialAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                document.getElementById('loading-indicator').innerHTML = `<p class="text-red-500">Auth Error: ${error.message}</p>`;
            }
        }


        // 2. Navigation Logic
        let activeView = 'clients';

        function navigate(viewName) {
            activeView = viewName;
            const views = document.querySelectorAll('.view');
            views.forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`${viewName}-view`).classList.remove('hidden');

            // Update button styles
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-700/50', 'bg-indigo-700');
            });
            // Update the style for the active button
            const activeBtn = document.querySelector(`.nav-btn[onclick="navigate('${viewName}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-indigo-700/50', 'bg-indigo-700');
            }
        }
        
        // --- MODAL CONTROL ---

        function openModal(modalId) {
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById('modal-container').classList.add('hidden');
        }

        // 3. Firestore Listeners (Clients, Projects, Billing, and Descriptions)
        function setupListeners() {
            if (!db || !currentUserId) return; // Safely exit if not initialized/authenticated

            // 1. Clients Listener
            const clientsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/clients`);
            onSnapshot(query(clientsCollectionRef), (snapshot) => {
                clients = []; 
                snapshot.forEach(doc => {
                    clients.push({ id: doc.id, ...doc.data() });
                });
                renderClients(clients);
                populateClientDropdowns(clients); 
                if (projects.length > 0) renderProjects(projects); 
                if (billingEntries.length > 0) renderBillingEntries(billingEntries);
                console.log("Clients updated:", clients.length);
            }, (error) => {
                console.error("Error fetching clients:", error);
                showClientError("Failed to load clients. Please check console for details.");
            });

            // 2. Projects Listener
            const projectsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/projects`);
            onSnapshot(query(projectsCollectionRef), (snapshot) => {
                projects = []; 
                snapshot.forEach(doc => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                renderProjects(projects);
                if (billingEntries.length > 0) renderBillingEntries(billingEntries);
                console.log("Projects updated:", projects.length);
            }, (error) => {
                console.error("Error fetching projects:", error);
                showProjectError("Failed to load projects. Please check console for details.");
            });
            
            // 3. Billing Entries Listener
            const billingCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/billing`);
            onSnapshot(query(billingCollectionRef), (snapshot) => {
                billingEntries = [];
                snapshot.forEach(doc => {
                    billingEntries.push({ id: doc.id, ...doc.data() });
                });
                renderBillingEntries(billingEntries);
                console.log("Billing entries updated:", billingEntries.length);
            }, (error) => {
                console.error("Error fetching billing entries:", error);
                showBillingError("Failed to load billing entries. Please check console for details.");
            });
            
            // 4. Work Descriptions Listener
            const descCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/billing-descriptions`);
            onSnapshot(query(descCollectionRef), (snapshot) => {
                workDescriptions = [];
                snapshot.forEach(doc => {
                    workDescriptions.push({ id: doc.id, ...doc.data() });
                });
                populateDescriptionDropdown(workDescriptions, 'saved-description-select'); // For Add form
                populateDescriptionDropdown(workDescriptions, 'edit-saved-description-select'); // For Edit form
                console.log("Work descriptions updated:", workDescriptions.length);
            }, (error) => {
                console.error("Error fetching work descriptions:", error);
            });
        }

        // --- GENERAL DROPDOWN POPULATION ---

        function populateClientDropdowns(clients) {
            const projectSelect = document.getElementById('project-client-id');
            const billingClientSelect = document.getElementById('billing-client-id');
            const editProjectClientSelect = document.getElementById('edit-project-client-id'); // For Edit Project Modal

            [projectSelect, billingClientSelect, editProjectClientSelect].forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="" disabled selected>Select Associated Client *</option>'; 
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id; 
                    option.textContent = `${client.name} (${client.companyName || 'Individual'})`;
                    if (client.id === currentValue) {
                         option.selected = true; // Retain selection if possible
                    }
                    select.appendChild(option);
                });

                if (clients.length === 0) {
                    select.innerHTML += '<option disabled>Please add a client first.</option>';
                }
            });
            handleBillingClientChange();
        }
        
        // Populates the dropdown with saved work descriptions
        function populateDescriptionDropdown(descriptions, selectId) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = '<option value="" disabled selected>--- Load Saved Description ---</option>'; 
            
            descriptions.sort((a, b) => a.description.localeCompare(b.description));

            descriptions.forEach(desc => {
                const option = document.createElement('option');
                option.value = desc.description; 
                option.textContent = desc.description;
                if (desc.description === currentValue) {
                    option.selected = true; // Retain selection if possible
                }
                select.appendChild(option);
            });
        }

        // --- CLIENT FUNCTIONS (CRUD) ---
        
        async function addClient(event) {
            event.preventDefault();
            
            // NEW CHECK
            if (!db || !currentUserId) { showClientError("Persistence disabled in local mode. Cannot save."); return; }

            const nameInput = document.getElementById('client-name');
            const companyInput = document.getElementById('client-company');
            const addressInput = document.getElementById('client-address');
            const contactInput = document.getElementById('client-contact');
            const errorElement = document.getElementById('client-error');

            const name = nameInput.value.trim();
            const companyName = companyInput.value.trim();
            const address = addressInput.value.trim();
            const contact = contactInput.value.trim();

            if (!name) {
                showClientError("Client name is required.");
                return;
            }
            errorElement.classList.add('hidden');

            try {
                const clientsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/clients`);
                await addDoc(clientsCollectionRef, {
                    name: name,
                    companyName: companyName,
                    address: address,
                    contact: contact,
                    createdAt: serverTimestamp()
                });

                nameInput.value = '';
                companyInput.value = '';
                addressInput.value = '';
                contactInput.value = '';
            } catch (e) {
                console.error("Error adding client: ", e);
                showClientError("Failed to add client. Check network connection.");
            }
        }

        async function deleteClient(clientId) {
            if (!db || !currentUserId) return;
            try {
                const clientDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/clients`, clientId);
                await deleteDoc(clientDocRef);
            } catch (error) {
                console.error("Error deleting client: ", error);
                showClientError("Failed to delete client. Try again.");
            }
        }
        
        function showEditClientModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            document.getElementById('edit-client-id').value = clientId;
            document.getElementById('edit-client-name').value = client.name;
            document.getElementById('edit-client-company').value = client.companyName || '';
            document.getElementById('edit-client-address').value = client.address || '';
            document.getElementById('edit-client-contact').value = client.contact || '';
            document.getElementById('edit-client-error').classList.add('hidden');

            openModal('edit-client-modal');
        }

        async function updateClient(event) {
            event.preventDefault();
            
            // NEW CHECK
            if (!db || !currentUserId) { 
                document.getElementById('edit-client-error').textContent = "Persistence disabled in local mode. Cannot save.";
                document.getElementById('edit-client-error').classList.remove('hidden');
                return; 
            }

            const clientId = document.getElementById('edit-client-id').value;
            const name = document.getElementById('edit-client-name').value.trim();
            const companyName = document.getElementById('edit-client-company').value.trim();
            const address = document.getElementById('edit-client-address').value.trim();
            const contact = document.getElementById('edit-client-contact').value.trim();
            const errorElement = document.getElementById('edit-client-error');

            if (!name) {
                errorElement.textContent = "Client name is required.";
                errorElement.classList.remove('hidden');
                return;
            }
            errorElement.classList.add('hidden');

            try {
                const clientDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/clients`, clientId);
                await updateDoc(clientDocRef, {
                    name: name,
                    companyName: companyName,
                    address: address,
                    contact: contact
                });
                closeModal('edit-client-modal');
            } catch (e) {
                console.error("Error updating client: ", e);
                errorElement.textContent = "Failed to update client. Check connection.";
                errorElement.classList.remove('hidden');
            }
        }

        function renderClients(clients) {
            const listElement = document.getElementById('clients-list');
            const countElement = document.getElementById('client-count');
            const noClientsMsg = document.getElementById('no-clients-message');
            listElement.innerHTML = ''; 

            countElement.textContent = `${clients.length} Client${clients.length === 1 ? '' : 's'}`;

            if (clients.length === 0) {
                noClientsMsg.classList.remove('hidden');
                return;
            }
            noClientsMsg.classList.add('hidden');

            clients.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            clients.forEach(client => {
                const clientRow = `
                    <tr class="hover:bg-indigo-50 transition duration-100">
                        <td class="px-3 py-3 text-sm font-medium text-gray-900 truncate-cell">${client.name}</td>
                        <td class="px-3 py-3 text-sm text-gray-600 truncate-cell">${client.companyName || 'N/A'}</td>
                        <td class="px-3 py-3 text-sm text-gray-500 hidden sm:table-cell truncate-cell">${client.address || 'N/A'}</td>
                        <td class="px-3 py-3 text-sm text-gray-500 hidden md:table-cell truncate-cell">${client.contact || 'N/A'}</td>
                        
                        <td class="px-3 py-3 text-right text-sm font-medium">
                            <div class="flex justify-end space-x-1">
                                <button title="Edit Client" onclick="editClient('${client.id}')"
                                    class="p-2 text-indigo-500 hover:text-indigo-700 rounded-full hover:bg-indigo-100 transition duration-150">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                
                                <button title="Delete Client" onclick="deleteClient('${client.id}')"
                                    class="p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 transition duration-150">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                listElement.insertAdjacentHTML('beforeend', clientRow);
            });
            lucide.createIcons();
        }

        function showClientError(message) {
            const errorElement = document.getElementById('client-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // --- PROJECT FUNCTIONS (CRUD) ---

        async function addProject(event) {
            event.preventDefault();
            
            // NEW CHECK
            if (!db || !currentUserId) { showProjectError("Persistence disabled in local mode. Cannot save."); return; }

            const nameInput = document.getElementById('project-name');
            const clientIdSelect = document.getElementById('project-client-id');
            const typeSelect = document.getElementById('project-type-of-work');
            const activeSelect = document.getElementById('project-is-active');
            const errorElement = document.getElementById('project-error');

            const name = nameInput.value.trim();
            const clientId = clientIdSelect.value;
            const typeOfWork = typeSelect.value;
            const isActive = activeSelect.value === 'yes';

            if (!name || !clientId || !typeOfWork) {
                showProjectError("Please fill in all required project fields.");
                return;
            }
            errorElement.classList.add('hidden');

            try {
                const projectsCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/projects`);
                await addDoc(projectsCollectionRef, {
                    name: name,
                    clientId: clientId, 
                    typeOfWork: typeOfWork,
                    isActive: isActive,
                    createdAt: serverTimestamp()
                });

                nameInput.value = '';
                clientIdSelect.selectedIndex = 0;
                typeSelect.selectedIndex = 0;
                activeSelect.value = 'yes';
            } catch (e) {
                console.error("Error adding project: ", e);
                showProjectError("Failed to add project. Check connection.");
            }
        }

        async function deleteProject(projectId) {
            if (!db || !currentUserId) return;
            try {
                const projectDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, projectId);
                await deleteDoc(projectDocRef);
            } catch (error) {
                console.error("Error deleting project: ", error);
                showProjectError("Failed to delete project. Try again.");
            }
        }

        function showEditProjectModal(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            document.getElementById('edit-project-id').value = projectId;
            document.getElementById('edit-project-name').value = project.name;
            document.getElementById('edit-project-client-id').value = project.clientId;
            document.getElementById('edit-project-type-of-work').value = project.typeOfWork;
            document.getElementById('edit-project-is-active').value = project.isActive ? 'yes' : 'no';
            document.getElementById('edit-project-error').classList.add('hidden');
            
            populateClientDropdowns(clients); 

            openModal('edit-project-modal');
        }

        async function updateProject(event) {
            event.preventDefault();
            
            // NEW CHECK
            if (!db || !currentUserId) { 
                document.getElementById('edit-project-error').textContent = "Persistence disabled in local mode. Cannot save.";
                document.getElementById('edit-project-error').classList.remove('hidden');
                return; 
            }

            const projectId = document.getElementById('edit-project-id').value;
            const name = document.getElementById('edit-project-name').value.trim();
            const clientId = document.getElementById('edit-project-client-id').value;
            const typeOfWork = document.getElementById('edit-project-type-of-work').value;
            const isActive = document.getElementById('edit-project-is-active').value === 'yes';
            const errorElement = document.getElementById('edit-project-error');

            if (!name || !clientId || !typeOfWork) {
                errorElement.textContent = "Please fill in all required project fields.";
                errorElement.classList.remove('hidden');
                return;
            }
            errorElement.classList.add('hidden');

            try {
                const projectDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/projects`, projectId);
                await updateDoc(projectDocRef, {
                    name: name,
                    clientId: clientId,
                    typeOfWork: typeOfWork,
                    isActive: isActive
                });
                closeModal('edit-project-modal');
            } catch (e) {
                console.error("Error updating project: ", e);
                errorElement.textContent = "Failed to update project. Check connection.";
                errorElement.classList.remove('hidden');
            }
        }

        function renderProjects(projects) {
            const listElement = document.getElementById('projects-list');
            const countElement = document.getElementById('project-count');
            const noProjectsMsg = document.getElementById('no-projects-message');
            listElement.innerHTML = ''; 

            countElement.textContent = `${projects.length} Project${projects.length === 1 ? '' : 's'}`;

            if (projects.length === 0) {
                noProjectsMsg.classList.remove('hidden');
                return;
            }
            noProjectsMsg.classList.add('hidden');

            projects.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            projects.forEach(project => {
                const client = clients.find(c => c.id === project.clientId);
                const clientNameDisplay = client ? client.name : '<span class="text-red-500 font-semibold">Client Deleted</span>';
                const statusColor = project.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                const projectRow = `
                    <tr class="hover:bg-green-50 transition duration-100">
                        <td class="px-3 py-3 text-sm font-medium text-gray-900 truncate-cell">${project.name}</td>
                        
                        <td class="px-3 py-3 text-sm text-gray-600 truncate-cell">${clientNameDisplay}</td>
                        
                        <td class="px-3 py-3 text-sm text-gray-500 hidden sm:table-cell truncate-cell">${project.typeOfWork}</td>
                        
                        <td class="px-3 py-3 hidden md:table-cell truncate-cell">
                            <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                ${project.isActive ? 'Yes' : 'No'}
                            </span>
                        </td>
                        
                        <td class="px-3 py-3 text-right text-sm font-medium">
                            <div class="flex justify-end space-x-1">
                                <button title="Edit Project" onclick="editProject('${project.id}')"
                                    class="p-2 text-indigo-500 hover:text-indigo-700 rounded-full hover:bg-indigo-100 transition duration-150">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                
                                <button title="Delete Project" onclick="deleteProject('${project.id}')"
                                    class="p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 transition duration-150">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                listElement.insertAdjacentHTML('beforeend', projectRow);
            });
            lucide.createIcons();
        }

        function showProjectError(message) {
            const errorElement = document.getElementById('project-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // --- BILLING FUNCTIONS (CRUD) ---

        // Loads selected description into the input field
        function loadSavedDescription(inputId, selectId = 'saved-description-select') {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (selectId === 'saved-description-select') {
                // Logic for the Add Billing form
                const saveCheckbox = document.getElementById('save-new-description');
                if (select.value) {
                    input.value = select.value;
                    saveCheckbox.checked = false;
                }
            } else if (selectId === 'edit-saved-description-select') {
                 // Logic for the Edit Billing form
                if (select.value) {
                    input.value = select.value;
                }
            }
        }
        
        async function addWorkDescription(description) {
            // NEW CHECK
            if (!db || !currentUserId) return; 

            const normalizedDesc = description.trim();
            if (!normalizedDesc) return;

            const exists = workDescriptions.some(
                desc => desc.description.toLowerCase() === normalizedDesc.toLowerCase()
            );

            if (exists) return; 

            try {
                const descCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/billing-descriptions`);
                await addDoc(descCollectionRef, {
                    description: normalizedDesc,
                    createdAt: serverTimestamp()
                });
                console.log("New work description saved:", normalizedDesc);
            } catch (e) {
                console.error("Error saving work description: ", e);
            }
        }

        function handleBillingClientChange() {
            const clientId = document.getElementById('billing-client-id').value;
            const projectSelect = document.getElementById('billing-project-id');
            
            projectSelect.innerHTML = '<option value="" disabled selected>Select Project *</option>';
            projectSelect.value = ""; 
            updateBillingDetails(); 

            if (clientId) {
                const filteredProjects = projects.filter(p => p.clientId === clientId);
                populateBillingProjectDropdown(filteredProjects);
                projectSelect.disabled = false;
                projectSelect.classList.remove('disabled-select');
                
            } else {
                projectSelect.disabled = true;
                projectSelect.classList.add('disabled-select');
            }
        }

        function populateBillingProjectDropdown(filteredProjects) {
            const select = document.getElementById('billing-project-id');
            // 'Select Project *' is already the default first option

            filteredProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id; 
                option.textContent = project.name;
                select.appendChild(option);
            });

            if (filteredProjects.length === 0) {
                select.innerHTML += '<option disabled>No projects found for this client.</option>';
            }
        }

        function updateBillingDetails() {
            const projectId = document.getElementById('billing-project-id').value;
            const clientDisplay = document.getElementById('display-client-name');
            const workTypeDisplay = document.getElementById('display-work-type');
            
            clientDisplay.textContent = '---';
            workTypeDisplay.textContent = '---';

            if (!projectId) return;

            const project = projects.find(p => p.id === projectId);
            
            if (project) {
                const client = clients.find(c => c.id === project.clientId);
                clientDisplay.textContent = client ? client.name : 'Client Not Found';
                workTypeDisplay.textContent = project.typeOfWork;
            } else {
                clientDisplay.textContent = 'Project Not Found';
            }
        }
        
        async function addBillingEntry(event) {
            event.preventDefault();
            
            // NEW CHECK
            if (!db || !currentUserId) { showBillingError("Persistence disabled in local mode. Cannot save."); return; }

            const clientId = document.getElementById('billing-client-id').value; 
            const projectId = document.getElementById('billing-project-id').value;
            const date = document.getElementById('billing-date').value;
            const itemDesc = document.getElementById('billing-item-desc').value.trim();
            const rate = parseFloat(document.getElementById('billing-rate').value);
            const hours = parseFloat(document.getElementById('billing-hours').value);
            const jobDone = document.getElementById('billing-job-done').value === 'yes';
            const saveNew = document.getElementById('save-new-description').checked;
            const errorElement = document.getElementById('billing-error');

            if (!clientId || !projectId || !date || itemDesc === '' || isNaN(rate) || isNaN(hours) || rate < 0 || hours < 0) {
                showBillingError("Please ensure you have selected a Client/Project and all fields are correctly filled.");
                return;
            }
            errorElement.classList.add('hidden');

            try {
                const billingCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/billing`);
                await addDoc(billingCollectionRef, {
                    clientId: clientId, 
                    projectId: projectId,
                    date: date, 
                    itemDesc: itemDesc,
                    rate: rate,
                    hours: hours,
                    jobDone: jobDone,
                    createdAt: serverTimestamp()
                });

                if (saveNew) {
                    await addWorkDescription(itemDesc);
                }

                // Clear fields
                document.getElementById('billing-date').value = new Date().toISOString().slice(0, 10);
                document.getElementById('billing-item-desc').value = '';
                document.getElementById('billing-rate').value = '';
                document.getElementById('billing-hours').value = '';
                document.getElementById('billing-job-done').value = 'yes';
                document.getElementById('save-new-description').checked = false;
                
            } catch (e) {
                console.error("Error adding billing entry: ", e);
                showBillingError("Failed to add billable item. Check connection.");
            }
        }

        async function deleteBillingEntry(billingId) {
            if (!db || !currentUserId) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/billing`, billingId);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting billing entry: ", error);
                showBillingError("Failed to delete billable item. Try again.");
            }
        }
        
        function showEditBillingModal(billingId) {
            const entry = billingEntries.find(e => e.id === billingId);
            if (!entry) return;

            const project = projects.find(p => p.id === entry.projectId);
            const client = clients.find(c => c.id === entry.clientId);

            document.getElementById('edit-billing-id').value = billingId;
            document.getElementById('edit-billing-date').value = entry.date;
            document.getElementById('edit-billing-item-desc').value = entry.itemDesc;
            document.getElementById('edit-billing-rate').value = entry.rate;
            document.getElementById('edit-billing-hours').value = entry.hours;
            document.getElementById('edit-billing-job-done').value = entry.jobDone ? 'yes' : 'no';
            document.getElementById('edit-billing-error').classList.add('hidden');
            
            // Set read-only derived fields
            document.getElementById('edit-display-client-name').textContent = client ? client.name : 'N/A';
            document.getElementById('edit-display-project-name').textContent = project ? project.name : 'N/A';
            document.getElementById('edit-display-work-type').textContent = project ? project.typeOfWork : 'N/A';
            
            // Reset description dropdown selection
            document.getElementById('edit-saved-description-select').selectedIndex = 0;

            openModal('edit-billing-modal');
        }

        async function updateBillingEntry(event) {
            event.preventDefault();

            // NEW CHECK
            if (!db || !currentUserId) { 
                document.getElementById('edit-billing-error').textContent = "Persistence disabled in local mode. Cannot save.";
                document.getElementById('edit-billing-error').classList.remove('hidden');
                return; 
            }

            const billingId = document.getElementById('edit-billing-id').value;
            const date = document.getElementById('edit-billing-date').value;
            const itemDesc = document.getElementById('edit-billing-item-desc').value.trim();
            const rate = parseFloat(document.getElementById('edit-billing-rate').value);
            const hours = parseFloat(document.getElementById('edit-billing-hours').value);
            const jobDone = document.getElementById('edit-billing-job-done').value === 'yes';
            const errorElement = document.getElementById('edit-billing-error');

            if (!date || itemDesc === '' || isNaN(rate) || isNaN(hours) || rate < 0 || hours < 0) {
                errorElement.textContent = "Please ensure all fields are correctly filled.";
                errorElement.classList.remove('hidden');
                return;
            }
            errorElement.classList.add('hidden');

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/billing`, billingId);
                await updateDoc(docRef, {
                    date: date,
                    itemDesc: itemDesc,
                    rate: rate,
                    hours: hours,
                    jobDone: jobDone
                });
                closeModal('edit-billing-modal');
            } catch (e) {
                console.error("Error updating billing entry: ", e);
                errorElement.textContent = "Failed to update entry. Check connection.";
                errorElement.classList.remove('hidden');
            }
        }

        function renderBillingEntries(entries) {
            const listElement = document.getElementById('billing-list');
            const countElement = document.getElementById('billing-count');
            const noBillingMsg = document.getElementById('no-billing-message');
            listElement.innerHTML = ''; 

            countElement.textContent = `${entries.length} Entr${entries.length === 1 ? 'y' : 'ies'}`;

            if (entries.length === 0) {
                noBillingMsg.classList.remove('hidden');
                return;
            }
            noBillingMsg.classList.add('hidden');

            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            entries.forEach(entry => {
                const project = projects.find(p => p.id === entry.projectId);
                
                const projectNameDisplay = project ? project.name : '<span class="text-red-500 font-semibold">Project Deleted</span>';
                const totalCharge = (entry.rate * entry.hours).toFixed(2);
                
                const doneColor = entry.jobDone ? 'bg-teal-100 text-teal-800' : 'bg-orange-100 text-orange-800';

                const billingRow = `
                    <tr class="hover:bg-teal-50 transition duration-100">
                        <!-- Date / Project Name -->
                        <td class="px-3 py-3 text-sm font-medium text-gray-900 truncate-cell text-nowrap">
                            ${entry.date}<br>
                            <span class="text-xs text-gray-500">${projectNameDisplay}</span>
                        </td>
                        
                        <!-- Description -->
                        <td class="px-3 py-3 text-sm text-gray-600 hidden sm:table-cell truncate-cell">${entry.itemDesc}</td>
                        
                        <!-- Rate/Hours -->
                        <td class="px-3 py-3 text-sm text-gray-700 truncate-cell text-nowrap">
                            $${entry.rate.toFixed(2)} / hr<br>
                            <span class="text-xs text-gray-500">${entry.hours.toFixed(1)} hrs</span>
                        </td>
                        
                        <!-- Total Charge -->
                        <td class="px-3 py-3 text-right text-sm font-bold text-teal-700 truncate-cell text-nowrap">
                            $${totalCharge}
                        </td>
                        
                        <!-- Job Done Status -->
                        <td class="px-3 py-3 text-center hidden md:table-cell truncate-cell">
                            <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full ${doneColor}">
                                ${entry.jobDone ? 'Yes' : 'No'}
                            </span>
                        </td>
                        
                        <!-- Actions -->
                        <td class="px-3 py-3 text-right text-sm font-medium">
                            <div class="flex justify-end space-x-1 text-nowrap">
                                <button title="Edit Entry" onclick="editBillingEntry('${entry.id}')"
                                    class="p-2 text-indigo-500 hover:text-indigo-700 rounded-full hover:bg-indigo-100 transition duration-150">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                
                                <button title="Delete Entry" onclick="deleteBillingEntry('${entry.id}')"
                                    class="p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 transition duration-150">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                listElement.insertAdjacentHTML('beforeend', billingRow);
            });
            lucide.createIcons();
        }

        function showBillingError(message) {
            const errorElement = document.getElementById('billing-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // --- REPORTING FUNCTIONS (No Change) ---

        function showReportError(message) {
            const errorElement = document.getElementById('report-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        function calculateReports(event) {
            if (event) event.preventDefault();
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const groupBy = document.getElementById('report-group-by').value;
            const reportOutput = document.getElementById('report-output');

            if (!startDate || !endDate) {
                showReportError("Please select both a Start Date and End Date.");
                return;
            }
            if (startDate > endDate) {
                 showReportError("Start Date cannot be after End Date.");
                return;
            }
            showReportError(''); 

            // 1. Filter entries by date range
            const filteredEntries = billingEntries.filter(entry => {
                return entry.date >= startDate && entry.date <= endDate;
            });
            
            if (filteredEntries.length === 0) {
                reportOutput.innerHTML = `
                    <div class="bg-yellow-50 p-4 rounded-lg text-yellow-800 border border-yellow-200">
                        <p class="font-semibold">No data found.</p>
                        <p class="text-sm">There are no billable entries between ${startDate} and ${endDate}.</p>
                    </div>`;
                return;
            }

            // 2. Aggregate Totals
            const totals = filteredEntries.reduce((acc, entry) => {
                const charge = entry.rate * entry.hours;
                acc.totalHours += entry.hours;
                acc.totalCharge += charge;
                if (!entry.jobDone) {
                    acc.pendingCharge += charge;
                }
                return acc;
            }, { totalHours: 0, totalCharge: 0, pendingCharge: 0 });

            // 3. Group and Calculate Breakdown
            let breakdown = [];
            let breakdownHtml = '';
            
            if (groupBy === 'all') {
                // Summary only
            } else {
                breakdown = groupAndAggregate(filteredEntries, groupBy);
                breakdownHtml = renderBreakdownTable(breakdown, groupBy);
            }
            
            // 4. Render Final Report
            reportOutput.innerHTML = renderSummaryCards(totals, startDate, endDate) + breakdownHtml;
        }

        function groupAndAggregate(entries, groupBy) {
            const groups = {};

            entries.forEach(entry => {
                let key = '';
                let name = '';
                
                if (groupBy === 'client') {
                    key = entry.clientId;
                    const client = clients.find(c => c.id === entry.clientId);
                    name = client ? client.name : 'Unknown Client';
                } else if (groupBy === 'typeOfWork') {
                    const project = projects.find(p => p.id === entry.projectId);
                    key = project ? project.typeOfWork : 'Unknown Type';
                    name = key;
                } else {
                    return; 
                }

                if (!groups[key]) {
                    groups[key] = {
                        name: name,
                        totalHours: 0,
                        totalCharge: 0,
                        pendingCharge: 0,
                        count: 0
                    };
                }

                const charge = entry.rate * entry.hours;
                groups[key].totalHours += entry.hours;
                groups[key].totalCharge += charge;
                groups[key].count++;

                if (!entry.jobDone) {
                    groups[key].pendingCharge += charge;
                }
            });

            return Object.values(groups).sort((a, b) => b.totalCharge - a.totalCharge);
        }

        function renderSummaryCards(totals, startDate, endDate) {
            return `
                <div class="mb-6 border-b pb-4">
                    <h3 class="text-2xl font-semibold text-gray-800">Summary: ${startDate} to ${endDate}</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Total Charged -->
                    <div class="bg-indigo-50 p-4 rounded-xl shadow-md border-l-4 border-indigo-600">
                        <p class="text-sm font-medium text-indigo-700">Total Charged</p>
                        <p class="text-2xl font-extrabold text-indigo-900 mt-1">$${totals.totalCharge.toFixed(2)}</p>
                    </div>
                    <!-- Total Hours -->
                    <div class="bg-teal-50 p-4 rounded-xl shadow-md border-l-4 border-teal-600">
                        <p class="text-sm font-medium text-teal-700">Total Hours Logged</p>
                        <p class="text-2xl font-extrabold text-teal-900 mt-1">${totals.totalHours.toFixed(1)} hrs</p>
                    </div>
                    <!-- Pending Charge -->
                    <div class="bg-red-50 p-4 rounded-xl shadow-md border-l-4 border-red-600">
                        <p class="text-sm font-medium text-red-700">Pending Charges (Job not Done)</p>
                        <p class="text-2xl font-extrabold text-red-900 mt-1">$${totals.pendingCharge.toFixed(2)}</p>
                    </div>
                </div>
            `;
        }
        
        function renderBreakdownTable(breakdown, groupBy) {
            const groupTitle = groupBy === 'client' ? 'Client Name' : 'Type of Work';
            
            let tableRows = breakdown.map(item => `
                <tr class="hover:bg-gray-50 transition duration-100">
                    <td class="px-3 py-3 text-sm font-medium text-gray-900 truncate-cell">${item.name}</td>
                    <td class="px-3 py-3 text-sm text-gray-700 text-right">${item.totalHours.toFixed(1)} hrs</td>
                    <td class="px-3 py-3 text-sm font-bold text-teal-700 text-right">$${item.totalCharge.toFixed(2)}</td>
                    <td class="px-3 py-3 text-sm text-red-700 text-right">$${item.pendingCharge.toFixed(2)}</td>
                    <td class="px-3 py-3 text-sm text-gray-500 text-right">${item.count} entries</td>
                </tr>
            `).join('');

            return `
                <h3 class="text-xl font-semibold text-gray-700 mb-4 border-t pt-4">Breakdown by ${groupTitle}</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${groupTitle}</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Hrs</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Charge</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Pending Charge</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Entry Count</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }


        // --- Start Application ---
        document.getElementById('loading-indicator').classList.remove('hidden');
        
        window.onload = function() {
            const today = new Date().toISOString().slice(0, 10);
            
            document.getElementById('billing-date').value = today;

            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
            document.getElementById('report-end-date').value = today;
            document.getElementById('report-start-date').value = thirtyDaysAgo;
            
            initFirebase();
        }
    </script>
</body>
</html>

