<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Billing App</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <header class="bg-teal-600 text-white p-4 shadow">
    <h1 class="text-xl font-bold">Client Billing App</h1>
  </header>

  <main class="p-4">
    <section id="billing-view">
      <h2 class="text-2xl font-semibold mb-4">Billing</h2>

      <form id="billing-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Date</label>
          <input type="date" id="billing-date" class="border p-2 w-full rounded" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Description</label>
          <input type="text" id="billing-description" class="border p-2 w-full rounded" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Rate ($)</label>
          <input type="number" id="billing-rate" class="border p-2 w-full rounded" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Hours</label>
          <input type="number" id="billing-hours" class="border p-2 w-full rounded" required />
        </div>
        <button type="submit" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">
          Save Entry
        </button>
      </form>

      <div id="billing-entries" class="mt-6 space-y-4"></div>
    </section>
  </main>

  <footer class="bg-gray-200 text-gray-700 p-4 text-sm text-center">
    <p>&copy; 2025 Vodoco Services</p>
    <p id="app-info" class="mt-1 text-xs"></p>
  </footer>

  <!-- Configuración externa -->
  <script src="./config.js"></script>

  <!-- Firebase SDK Imports y lógica de la app -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } 
      from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    let db, auth, currentUserId;

    async function initFirebase() {
      try {
        const config = JSON.parse(window.__firebase_config);
        const app = initializeApp(config);
        db = getFirestore(app);
        auth = getAuth(app);

        signInAnonymously(auth).catch(console.error);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUserId = user.uid;
            document.getElementById("app-info").textContent =
              `App ID: ${window.__app_id} | User ID: ${currentUserId}`;
            listenToBillingEntries();
          }
        });
      } catch (e) {
        console.error("Firebase init error:", e);
        document.getElementById("app-info").textContent =
          "App ID: LOCAL (Non-Persistent) | User ID: ANONYMOUS/NO SAVE";
      }
    }

    async function saveBillingEntry(entry) {
      if (!db || !currentUserId) return;
      try {
        await addDoc(collection(db, "artifacts", window.__app_id, "users", currentUserId, "billing"), entry);
      } catch (e) {
        console.error("Error saving billing:", e);
      }
    }

    function listenToBillingEntries() {
      const q = query(
        collection(db, "artifacts", window.__app_id, "users", currentUserId, "billing"),
        orderBy("date", "desc")
      );
      onSnapshot(q, (snapshot) => {
        const container = document.getElementById("billing-entries");
        container.innerHTML = "";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "border p-2 bg-white shadow rounded";
          div.innerHTML = `
            <p><strong>${data.date}</strong> - ${data.description}</p>
            <p>$${data.rate.toFixed(2)} × ${data.hours} hrs = 
              <strong>$${(data.rate * data.hours).toFixed(2)}</strong></p>
          `;
          container.appendChild(div);
        });
      });
    }

    document.getElementById("billing-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const entry = {
        date: document.getElementById("billing-date").value,
        description: document.getElementById("billing-description").value,
        rate: parseFloat(document.getElementById("billing-rate").value),
        hours: parseFloat(document.getElementById("billing-hours").value),
        createdAt: Date.now(),
      };
      saveBillingEntry(entry);
      e.target.reset();
    });

    window.onload = initFirebase;
  </script>

</body>
</html>
